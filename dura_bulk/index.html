<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dura Bulk Detector</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #0f1117;
    color: #e0e0e0;
    min-height: 100vh;
    padding: 2rem;
  }
  h1 {
    text-align: center;
    font-size: 2rem;
    margin-bottom: 0.5rem;
    color: #fff;
  }
  .subtitle {
    text-align: center;
    color: #888;
    margin-bottom: 2rem;
  }
  .card {
    background: #1a1d27;
    border-radius: 12px;
    padding: 1.5rem;
    max-width: 700px;
    margin: 0 auto 2rem;
    border: 1px solid #2a2d37;
  }

  /* Setup banner */
  #setup-banner {
    background: #2a1a1a;
    border: 1px solid #f4433680;
    max-width: 700px;
    margin: 0 auto 2rem;
    border-radius: 12px;
    padding: 1.5rem;
    display: none;
  }
  #setup-banner.show { display: block; }
  #setup-banner h2 { color: #f44336; font-size: 1.1rem; margin-bottom: 0.8rem; }
  #setup-banner p { color: #ccc; font-size: 0.9rem; line-height: 1.6; margin-bottom: 0.6rem; }
  #setup-banner code {
    display: block;
    background: #0f1117;
    padding: 0.6rem 0.8rem;
    border-radius: 6px;
    font-size: 0.85rem;
    color: #4caf50;
    margin: 0.4rem 0;
    overflow-x: auto;
    white-space: pre;
  }
  #setup-banner .step-num {
    display: inline-block;
    background: #f44336;
    color: #fff;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    text-align: center;
    line-height: 22px;
    font-size: 0.75rem;
    font-weight: 700;
    margin-right: 0.4rem;
  }
  .connected-badge {
    display: none;
    background: #1a2a1a;
    border: 1px solid #4caf5080;
    border-radius: 8px;
    padding: 0.6rem 1rem;
    max-width: 700px;
    margin: 0 auto 1.5rem;
    text-align: center;
    color: #4caf50;
    font-size: 0.9rem;
  }
  .connected-badge.show { display: block; }

  label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.3rem;
    color: #ccc;
  }
  input[type="text"], input[type="date"] {
    width: 100%;
    padding: 0.6rem 0.8rem;
    border: 1px solid #3a3d47;
    border-radius: 8px;
    background: #0f1117;
    color: #e0e0e0;
    font-size: 1rem;
    margin-bottom: 1rem;
  }
  input:focus { outline: none; border-color: #4a90d9; }
  .date-row { display: flex; gap: 1rem; }
  .date-row > div { flex: 1; }
  button {
    width: 100%;
    padding: 0.8rem;
    border: none;
    border-radius: 8px;
    background: #4a90d9;
    color: #fff;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:hover { background: #3a7bc8; }
  button:disabled { background: #333; cursor: not-allowed; }

  /* Upload section */
  .or-divider {
    text-align: center;
    color: #555;
    margin: 1.2rem 0;
    position: relative;
  }
  .or-divider::before, .or-divider::after {
    content: "";
    position: absolute;
    top: 50%;
    width: 40%;
    height: 1px;
    background: #2a2d37;
  }
  .or-divider::before { left: 0; }
  .or-divider::after { right: 0; }
  .drop-zone {
    border: 2px dashed #3a3d47;
    border-radius: 10px;
    padding: 2rem;
    text-align: center;
    color: #666;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    margin-bottom: 1rem;
  }
  .drop-zone:hover, .drop-zone.dragover {
    border-color: #4a90d9;
    background: #1a1d2f;
  }
  .drop-zone input { display: none; }

  /* Progress */
  #progress-section { display: none; }
  .progress-bar-outer {
    width: 100%;
    height: 8px;
    background: #2a2d37;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.8rem;
  }
  .progress-bar-inner {
    height: 100%;
    background: #4a90d9;
    border-radius: 4px;
    transition: width 0.3s;
    width: 0%;
  }
  #status-text { color: #aaa; font-size: 0.9rem; }

  /* Results */
  #results-section { display: none; max-width: 1200px; margin: 0 auto; }
  .results-header {
    text-align: center;
    font-size: 1.3rem;
    margin-bottom: 1rem;
    color: #fff;
  }
  .columns { display: flex; gap: 2rem; }
  @media (max-width: 700px) { .columns { flex-direction: column; } }
  .column { flex: 1; }
  .column h3 {
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #2a2d37;
  }
  .column h3.dura { border-color: #4caf50; color: #4caf50; }
  .column h3.non-dura { border-color: #f44336; color: #f44336; }
  .gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  .gallery img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    border-radius: 6px;
    cursor: pointer;
    transition: transform 0.15s;
  }
  .gallery img:hover { transform: scale(1.05); }
  .dl-btn {
    display: inline-block;
    width: auto;
    padding: 0.5rem 1.2rem;
    font-size: 0.85rem;
    background: #2a2d37;
    border-radius: 6px;
    text-decoration: none;
    color: #e0e0e0;
    border: 1px solid #3a3d47;
    cursor: pointer;
    transition: background 0.2s;
  }
  .dl-btn:hover { background: #3a3d47; }
  .empty-msg { color: #666; font-style: italic; padding: 1rem 0; }

  /* Lightbox */
  .lightbox {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    z-index: 100;
    justify-content: center;
    align-items: center;
    cursor: pointer;
  }
  .lightbox.active { display: flex; }
  .lightbox img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 8px;
  }
</style>
</head>
<body>

<h1>Dura Bulk Detector</h1>
<p class="subtitle">Scrape Instagram images, detect boats, find "Dura Bulk" text</p>

<!-- Setup instructions (shown when backend not detected) -->
<div id="setup-banner">
  <h2>Backend not detected</h2>
  <p>This app needs a local Python backend for Instagram scraping and AI detection. One-time setup:</p>
  <p><span class="step-num">1</span> Clone the repo and install dependencies:</p>
  <code>git clone https://github.com/ahnjili/artificialnouveauworkshops.git
cd artificialnouveauworkshops/dura_bulk
pip install -r requirements.txt</code>
  <p><span class="step-num">2</span> Start the backend:</p>
  <code>python app.py</code>
  <p><span class="step-num">3</span> Come back to this page — it will auto-connect.</p>
  <p style="color:#888; font-size:0.8rem; margin-top:0.8rem;">The backend runs on http://localhost:5001. This page checks every 3 seconds.</p>
  <p style="margin-top:0.8rem;"><span class="step-num">?</span> <strong>Or use Google Colab:</strong> Open the
    <a href="https://colab.research.google.com/github/ahnjili/artificialnouveauworkshops/blob/main/dura_bulk/Dura_Bulk_Detector.ipynb"
       target="_blank" style="color:#4a90d9;">Colab notebook</a>
    to run the full pipeline with free GPU — results save directly to your Google Drive.</p>
</div>

<div class="connected-badge" id="connected-badge">Connected to backend</div>

<!-- Custom backend URL (for ngrok / Colab) -->
<div class="card" style="max-width:700px; padding:0.8rem 1.2rem;">
  <label for="api-url" style="font-size:0.85rem; margin-bottom:0.2rem;">Backend URL</label>
  <div style="display:flex; gap:0.5rem;">
    <input type="text" id="api-url" value="http://localhost:5001" style="margin-bottom:0; flex:1; font-size:0.85rem;">
    <button type="button" id="reconnect-btn" style="width:auto; padding:0.5rem 1rem; font-size:0.85rem;">Connect</button>
  </div>
</div>

<div class="card">
  <form id="scrape-form">
    <label for="profile">Instagram Profile</label>
    <input type="text" id="profile" placeholder="e.g. durabulk (no @ needed)" required>

    <div class="date-row">
      <div>
        <label for="start_date">Start Date</label>
        <input type="date" id="start_date" required>
      </div>
      <div>
        <label for="end_date">End Date</label>
        <input type="date" id="end_date" required>
      </div>
    </div>

    <label for="max_posts">Max Posts</label>
    <input type="number" id="max_posts" value="100" min="1" max="500">

    <button type="submit" id="start-btn" disabled>Start Detection</button>

    <div class="or-divider">or upload images directly</div>

    <div class="drop-zone" id="drop-zone">
      <p>Drag & drop images here, or click to browse</p>
      <input type="file" id="file-input" multiple accept="image/*">
    </div>
    <button type="button" id="upload-btn" style="display:none;">Detect Boats in Uploaded Images</button>
  </form>
</div>

<div class="card" id="progress-section">
  <div class="progress-bar-outer">
    <div class="progress-bar-inner" id="progress-bar"></div>
  </div>
  <div id="status-text">Starting...</div>
</div>

<div id="results-section">
  <p class="results-header" id="results-summary"></p>
  <div class="columns">
    <div class="column">
      <h3 class="dura">Dura Bulk (<span id="dura-count">0</span>)</h3>
      <div class="gallery" id="dura-gallery"></div>
      <a class="dl-btn" id="dl-dura" style="display:none;">Download ZIP</a>
    </div>
    <div class="column">
      <h3 class="non-dura">Non-Dura Bulk (<span id="non-dura-count">0</span>)</h3>
      <div class="gallery" id="non-dura-gallery"></div>
      <a class="dl-btn" id="dl-non-dura" style="display:none;">Download ZIP</a>
    </div>
  </div>
</div>

<div class="lightbox" id="lightbox" onclick="this.classList.remove('active')">
  <img id="lightbox-img" src="" alt="Full size">
</div>

<script>
let API = "http://localhost:5001";
let backendReady = false;
let uploadedFiles = [];

// DOM refs
const form = document.getElementById("scrape-form");
const startBtn = document.getElementById("start-btn");
const uploadBtn = document.getElementById("upload-btn");
const progressSection = document.getElementById("progress-section");
const progressBar = document.getElementById("progress-bar");
const statusText = document.getElementById("status-text");
const resultsSection = document.getElementById("results-section");
const resultsSummary = document.getElementById("results-summary");
const duraGallery = document.getElementById("dura-gallery");
const nonDuraGallery = document.getElementById("non-dura-gallery");
const duraCount = document.getElementById("dura-count");
const nonDuraCount = document.getElementById("non-dura-count");
const dlDura = document.getElementById("dl-dura");
const dlNonDura = document.getElementById("dl-non-dura");
const lightbox = document.getElementById("lightbox");
const lightboxImg = document.getElementById("lightbox-img");
const setupBanner = document.getElementById("setup-banner");
const connectedBadge = document.getElementById("connected-badge");
const dropZone = document.getElementById("drop-zone");
const fileInput = document.getElementById("file-input");

const apiUrlInput = document.getElementById("api-url");
const reconnectBtn = document.getElementById("reconnect-btn");
let pollTimer = null;
let backendCheckInterval = null;

// --- Reconnect button ---
reconnectBtn.addEventListener("click", () => {
  API = apiUrlInput.value.replace(/\/+$/, "");
  backendReady = false;
  connectedBadge.classList.remove("show");
  setupBanner.classList.add("show");
  startBtn.disabled = true;
  if (backendCheckInterval) clearInterval(backendCheckInterval);
  checkBackend();
  backendCheckInterval = setInterval(async () => {
    if (await checkBackend()) clearInterval(backendCheckInterval);
  }, 3000);
});

// --- Backend detection ---
async function checkBackend() {
  try {
    const res = await fetch(API + "/api/status/ping", { mode: "cors" });
    // Even a 404 means the server is up
    backendReady = true;
    setupBanner.classList.remove("show");
    connectedBadge.classList.add("show");
    startBtn.disabled = false;
    return true;
  } catch {
    backendReady = false;
    setupBanner.classList.add("show");
    connectedBadge.classList.remove("show");
    startBtn.disabled = true;
    return false;
  }
}

// Check immediately then every 3s until connected
checkBackend();
backendCheckInterval = setInterval(async () => {
  if (await checkBackend()) clearInterval(backendCheckInterval);
}, 3000);

// --- File upload / drag-drop ---
dropZone.addEventListener("click", () => fileInput.click());
dropZone.addEventListener("dragover", (e) => {
  e.preventDefault();
  dropZone.classList.add("dragover");
});
dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
dropZone.addEventListener("drop", (e) => {
  e.preventDefault();
  dropZone.classList.remove("dragover");
  handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener("change", () => handleFiles(fileInput.files));

function handleFiles(files) {
  uploadedFiles = Array.from(files).filter(f => f.type.startsWith("image/"));
  if (uploadedFiles.length > 0) {
    dropZone.querySelector("p").textContent = `${uploadedFiles.length} image(s) selected`;
    uploadBtn.style.display = "block";
  }
}

// --- Scrape form submit ---
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!backendReady) return;

  const profile = document.getElementById("profile").value.trim();
  const startDate = document.getElementById("start_date").value;
  const endDate = document.getElementById("end_date").value;
  const maxPosts = document.getElementById("max_posts").value;
  if (!profile || !startDate || !endDate) return;

  startBtn.disabled = true;
  startBtn.textContent = "Running...";
  showProgress("Starting...");

  try {
    const res = await fetch(API + "/api/scrape", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ profile, start_date: startDate, end_date: endDate, max_posts: maxPosts }),
    });
    const data = await res.json();
    if (data.error) {
      statusText.textContent = "Error: " + data.error;
      resetBtn();
      return;
    }
    pollStatus(data.job_id);
  } catch (err) {
    statusText.textContent = "Request failed: " + err.message;
    resetBtn();
  }
});

// --- Upload button ---
uploadBtn.addEventListener("click", async () => {
  if (!backendReady || uploadedFiles.length === 0) return;

  uploadBtn.disabled = true;
  uploadBtn.textContent = "Uploading...";
  showProgress("Uploading images...");

  const formData = new FormData();
  uploadedFiles.forEach(f => formData.append("images", f));

  try {
    const res = await fetch(API + "/api/upload", {
      method: "POST",
      body: formData,
    });
    const data = await res.json();
    if (data.error) {
      statusText.textContent = "Error: " + data.error;
      uploadBtn.disabled = false;
      uploadBtn.textContent = "Detect Boats in Uploaded Images";
      return;
    }
    pollStatus(data.job_id);
  } catch (err) {
    statusText.textContent = "Upload failed: " + err.message;
    uploadBtn.disabled = false;
    uploadBtn.textContent = "Detect Boats in Uploaded Images";
  }
});

// --- Polling ---
function pollStatus(jobId) {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    try {
      const res = await fetch(`${API}/api/status/${jobId}`);
      const job = await res.json();

      statusText.textContent = job.detail || job.step;

      if (job.total > 0 && job.current > 0) {
        progressBar.style.width = Math.round((job.current / job.total) * 100) + "%";
      } else if (job.step === "scraping") {
        progressBar.style.width = "30%";
      }

      if (job.step === "done") {
        clearInterval(pollTimer);
        progressBar.style.width = "100%";
        resetBtn();
        showResults(job.results);
      } else if (job.step === "error") {
        clearInterval(pollTimer);
        resetBtn();
      }
    } catch { /* keep polling */ }
  }, 1500);
}

// --- UI helpers ---
function showProgress(msg) {
  progressSection.style.display = "block";
  resultsSection.style.display = "none";
  progressBar.style.width = "0%";
  statusText.textContent = msg;
}

function resetBtn() {
  startBtn.disabled = false;
  startBtn.textContent = "Start Detection";
  uploadBtn.disabled = false;
  uploadBtn.textContent = "Detect Boats in Uploaded Images";
}

function showResults(results) {
  resultsSection.style.display = "block";
  duraGallery.innerHTML = "";
  nonDuraGallery.innerHTML = "";

  const dura = results.dura_bulk || [];
  const nonDura = results.non_dura_bulk || [];

  duraCount.textContent = dura.length;
  nonDuraCount.textContent = nonDura.length;
  resultsSummary.textContent =
    `Found ${dura.length + nonDura.length} images: ${dura.length} with "Dura Bulk", ${nonDura.length} without.`;

  dura.forEach((name) => {
    const img = document.createElement("img");
    img.src = `${API}/api/images/dura_bulk/${encodeURIComponent(name)}`;
    img.alt = name;
    img.onclick = () => openLightbox(img.src);
    duraGallery.appendChild(img);
  });

  nonDura.forEach((name) => {
    const img = document.createElement("img");
    img.src = `${API}/api/images/non_dura_bulk/${encodeURIComponent(name)}`;
    img.alt = name;
    img.onclick = () => openLightbox(img.src);
    nonDuraGallery.appendChild(img);
  });

  if (dura.length === 0) duraGallery.innerHTML = '<p class="empty-msg">No matches found.</p>';
  if (nonDura.length === 0) nonDuraGallery.innerHTML = '<p class="empty-msg">No images.</p>';

  dlDura.href = `${API}/api/download/dura_bulk`;
  dlNonDura.href = `${API}/api/download/non_dura_bulk`;
  dlDura.style.display = dura.length > 0 ? "inline-block" : "none";
  dlNonDura.style.display = nonDura.length > 0 ? "inline-block" : "none";
}

function openLightbox(src) {
  lightboxImg.src = src;
  lightbox.classList.add("active");
}
</script>

</body>
</html>
